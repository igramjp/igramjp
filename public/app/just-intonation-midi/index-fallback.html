<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-Time Just Intonation Frequencies – A Web MIDI Experiment | igram.jp</title>
  <link href="static/output.css" rel="stylesheet" />
</head>

<body class="bg-white p-4">
  <div>
    <label for="frequency" class="w-full font-mono text-sm font-medium text-gray-700">Reference Frequency(Hz):</label>
    <input type="number" id="frequency" name="frequency" value="440.0"
      class="mb-2 mt-1 block w-min rounded-md border border-gray-300 px-1 py-1 font-mono shadow-sm focus:outline-none sm:text-sm" />
  </div>
  <div>
    <label for="rootKey" class="w-full font-mono text-sm font-medium text-gray-700">Root Key:</label>
    <select id="rootKey" name="rootKey"
      class="mb-2 mt-1 block w-min rounded-md border border-gray-300 bg-white px-1 py-1 font-mono shadow-sm focus:outline-none sm:text-sm">
      <option value="C">C</option>
      <option value="C#">C#</option>
      <option value="D">D</option>
      <option value="D#">D#</option>
      <option value="E">E</option>
      <option value="F">F</option>
      <option value="F#">F#</option>
      <option value="G">G</option>
      <option value="G#">G#</option>
      <option value="A">A</option>
      <option value="A#">A#</option>
      <option value="B">B</option>
    </select>
  </div>
  <div id="output" class="mt-4 inline-flex bg-black px-3 py-1 font-mono text-base font-medium text-white">
    Waiting for MIDI input...
  </div>

  <!-- スクリプトを直接読み込み -->
  <script src="./js/helpers.js"></script>
  <script src="./pkg/midi_web.js"></script>

  <script>
    // グローバル変数として定義
    window.log_to_js = function (message) {
      const outputDiv = document.getElementById("output");
      outputDiv.innerText = message;
    };

    async function run() {
      try {
        await init();
        console.log('WASM初期化完了');
      } catch (error) {
        console.error('WASM初期化エラー:', error);
        document.getElementById("output").textContent = "WASM初期化エラー: " + error.message;
      }
    }

    function onMIDIMessage(message) {
      const [status, note, velocity] = message.data;
      if (status === 144 && velocity > 0) {
        // Note On message
        const frequency = document.getElementById("frequency").value;
        const rootKey = document.getElementById("rootKey").value;
        sendNoteToRust(note, parseFloat(frequency), rootKey);
      }
    }

    navigator.requestMIDIAccess().then((access) => {
      console.log("MIDI access granted");
      const inputs = access.inputs.values();
      let inputCount = 0;
      for (let input of inputs) {
        console.log("MIDI input found:", input.name);
        input.onmidimessage = onMIDIMessage;
        inputCount++;
      }
      document.getElementById("output").textContent = inputCount > 0 ?
        `MIDI ready (${inputCount} devices)` : "No MIDI devices found";
    }).catch((error) => {
      console.error("MIDI access failed:", error);
      document.getElementById("output").textContent = "MIDI access denied: " + error.message;
    });

    // ページ読み込み完了後に実行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run);
    } else {
      run();
    }
  </script>
</body>

</html>